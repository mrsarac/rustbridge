version: '3.8'

services:
  rustbridge:
    build: .
    image: mrsarac/rustbridge:latest
    container_name: rustbridge
    ports:
      - "3000:3000"
    volumes:
      - ./config.yaml:/app/config.yaml:ro
    environment:
      - RUST_LOG=info
      - RUSTBRIDGE_CONFIG=/app/config.yaml
    depends_on:
      - mosquitto
    restart: unless-stopped
    networks:
      - rustbridge-net

  mosquitto:
    image: eclipse-mosquitto:2
    container_name: rustbridge-mqtt
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config:ro
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
    restart: unless-stopped
    networks:
      - rustbridge-net

  # Optional: Modbus simulator for testing
  modbus-simulator:
    image: oitc/modbus-server:latest
    container_name: rustbridge-modbus-sim
    ports:
      - "5020:5020"
    environment:
      - MODBUS_SERVER_PORT=5020
    restart: unless-stopped
    networks:
      - rustbridge-net
    profiles:
      - dev

volumes:
  mosquitto-data:
  mosquitto-log:

networks:
  rustbridge-net:
    driver: bridge
